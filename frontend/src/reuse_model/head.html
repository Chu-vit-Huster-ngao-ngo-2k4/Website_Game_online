<title>HUST Online Games</title>
<link rel="icon" type="image/x-icon" href="../images/favicon.ico">

<link rel="stylesheet" href="../css/base.css">
<link rel="stylesheet" href="../css/main.css">

<nav class="navbar">
    <div class="nav-brand">
        <a href="index.html"><img src="../images/logo_Game_Web.png" alt="HUST Games" style="width: 50px; height: 50px;">HUSTOnGame</a>
    </div>
    <div class="nav-links">
        <a href="index.html">Trang chủ</a>
        <a href="profile.html" class="auth-link" style="display: none;">Tài khoản</a>
        <a href="admin.html" class="admin-link" style="display: none;">Quản trị</a>
        <a href="login.html" class="guest-link">Đăng nhập</a>
        <a href="register.html" class="guest-link">Đăng ký</a>
        <a href="index.html" class="auth-link" style="display: none;" id="logoutBtn">Đăng xuất</a>
    </div>
</nav>

<style>
    .navbar {
        background: #1F2030;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        width: 100%;
        box-sizing: border-box;
        gap: 20px;
        position: fixed;
        top: 0;
        z-index: 100;
    }

    .nav-brand a {
        color: #fff;
        font-size: 20px;
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        white-space: nowrap;
    }

    .nav-brand img {
        width: 40px;
        height: 40px;
    }

    .search-container {
        flex: 1;
        max-width: 400px;
        margin: 0 20px;
        position: relative;
    }

    .search-bar {
        width: 100%;
        border: none;
        border-radius: 20px;
        background: #2a2a3a;
        color: #fff;
        font-size: 14px;
        transition: all 0.3s ease;
        padding: 10px 40px 10px 15px;
    }

    .search-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        padding: 5px;
        transition: color 0.3s ease;
    }

    .search-btn:hover {
        color: #4CAF50;
    }

    .search-bar:focus {
        outline: none;
        box-shadow: 0 0 0 2px #4CAF50;
        background: #2f2f42;
    }

    .search-bar::placeholder {
        color: #888;
    }

    .nav-links {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .nav-links a {
        color: #ccc;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 5px;
        transition: all 0.3s ease;
        white-space: nowrap;
        font-size: 14px;
    }

    .nav-links a:hover {
        color: #fff;
        background: rgba(255,255,255,0.1);
    }

    .nav-links a.active {
        color: #4CAF50;
        background: rgba(76,175,80,0.1);
    }

    .nav-links .auth-link,
    .nav-links .admin-link {
        color: #4CAF50;
    }

    .nav-links .auth-link:hover,
    .nav-links .admin-link:hover {
        background: rgba(76,175,80,0.2);
    }

    #logoutBtn {
        color: #f44336;
    }

    #logoutBtn:hover {
        background: rgba(244,67,54,0.1);
    }
</style>

<script>
    // Debug log to check if script is loaded
    console.log('Head script starting...');

    // Load modules
    import('../js/modules/auth.js').then(module => {
        window.auth = module.auth;
        console.log('Auth module loaded');
        
        // Kiểm tra trạng thái đăng nhập ngay khi load
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        console.log('Initial auth state:', {
            hasToken: !!token,
            user: user
        });
        
        // Cập nhật navigation sau khi load auth module
        updateNavigation();
    }).catch(error => {
        console.error('Error loading auth module:', error);
    });

    import('../js/modules/ui.js').then(module => {
        window.ui = module.ui;
        console.log('UI module loaded');
    }).catch(error => {
        console.error('Error loading UI module:', error);
    });

    // Update navigation based on auth status
    function updateNavigation() {
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        console.log('Raw user data from localStorage:', userStr);
        
        let user = {};
        try {
            user = JSON.parse(userStr || '{}');
            console.log('Parsed user data:', user);
        } catch (e) {
            console.error('Error parsing user data:', e);
        }
        
        // Update auth links visibility
        document.querySelectorAll('.auth-link').forEach(link => {
            link.style.display = token ? 'block' : 'none';
        });
        
        // Update guest links visibility
        document.querySelectorAll('.guest-link').forEach(link => {
            link.style.display = token ? 'none' : 'block';
        });
        
        // Update admin link visibility and setup click handler
        const adminLink = document.querySelector('.admin-link');
        if (adminLink) {
            // Kiểm tra role admin (case insensitive)
            const isAdmin = user && (
                user.role === 'admin' || 
                user.role === 'ADMIN' || 
                user.role === 'Admin'
            );
            
            console.log('Admin check:', {
                userExists: !!user,
                userRole: user.role,
                isAdmin: isAdmin
            });
            
            adminLink.style.display = isAdmin ? 'block' : 'none';
            
            // Remove existing click handlers
            const newAdminLink = adminLink.cloneNode(true);
            adminLink.parentNode.replaceChild(newAdminLink, adminLink);
            
            // Add new click handler
            newAdminLink.addEventListener('click', function(e) {
                if (!isAdmin) {
                    e.preventDefault();
                    alert('Bạn không có quyền truy cập trang quản trị!');
                    return false;
                }
            });
        }
    }

    // Set active link based on current page
    function setActiveLink() {
        console.log('Setting active link...');
        const currentPage = window.location.pathname.split('/').pop();
        const links = document.querySelectorAll('.nav-links a');
        links.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });
    }

    // Handle logout
    function setupLogout() {
        console.log('Setting up logout...');
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.auth) {
                    window.auth.logout();
                    // Cập nhật lại navigation sau khi logout
                    updateNavigation();
                } else {
                    console.error('Auth module not loaded');
                }
            });
        }
    }

    // Setup search functionality
    function setupSearch() {
        console.log('Setting up search...');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        console.log('Search elements:', { searchInput, searchBtn });

        if (searchInput && searchBtn) {
            console.log('Search elements found, adding event listeners...');

            // Hàm xử lý tìm kiếm
            const handleSearch = () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                console.log('Searching for:', searchTerm);
                
                // Kiểm tra xem có game-list không
                const gameList = document.querySelector('.game-list');
                if (!gameList) {
                    console.error('Game list container not found!');
                    return;
                }
                
                const games = gameList.querySelectorAll('.game-item');
                console.log('Found games:', games.length);
                
                if (games.length === 0) {
                    console.error('No game items found in the game list!');
                    return;
                }

                let hasResults = false;

                games.forEach((game, index) => {
                    const title = game.querySelector('.game-title')?.textContent.toLowerCase() || '';
                    const category = game.querySelector('.game-category')?.textContent.toLowerCase() || '';
                    console.log(`Game ${index + 1}:`, { title, category });
                    
                    if (title.includes(searchTerm) || category.includes(searchTerm)) {
                        game.style.display = 'block';
                        hasResults = true;
                        console.log(`Game ${index + 1} matched search term`);
                    } else {
                        game.style.display = 'none';
                        console.log(`Game ${index + 1} did not match search term`);
                    }
                });

                // Hiển thị thông báo khi không tìm thấy kết quả
                const noResultsMessage = document.querySelector('.no-results-message');
                if (!hasResults && searchTerm !== '') {
                    console.log('No results found, showing message');
                    if (!noResultsMessage) {
                        const message = document.createElement('div');
                        message.className = 'no-results-message';
                        message.innerHTML = `
                            <p>Không tìm thấy game nào phù hợp với "${searchTerm}"</p>
                            <p>Vui lòng thử từ khóa khác</p>
                        `;
                        gameList.appendChild(message);
                    }
                } else if (noResultsMessage) {
                    console.log('Removing no results message');
                    noResultsMessage.remove();
                }

                // Reset category filter khi tìm kiếm
                const categoryButtons = document.querySelectorAll('.category-btn');
                if (categoryButtons.length > 0) {
                    console.log('Resetting category filters');
                    categoryButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    const allCategoryBtn = document.querySelector('.category-btn[data-category="all"]');
                    if (allCategoryBtn) {
                        allCategoryBtn.classList.add('active');
                    }
                }
            };

            // Xử lý sự kiện click nút tìm kiếm
            searchBtn.addEventListener('click', (e) => {
                console.log('Search button clicked');
                e.preventDefault();
                handleSearch();
            });

            // Xử lý sự kiện phím Enter
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    console.log('Enter key pressed');
                    e.preventDefault();
                    handleSearch();
                }
            });

            // Thêm phím tắt
            document.addEventListener('keydown', (e) => {
                // Ctrl + K hoặc Command + K
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }
            });

            // Thêm style cho no-results-message
            const style = document.createElement('style');
            style.textContent = `
                .no-results-message {
                    text-align: center;
                    padding: 20px;
                    color: #888;
                    background: #2a2a3a;
                    border-radius: 8px;
                    margin: 20px 0;
                }
                .no-results-message p {
                    margin: 5px 0;
                }
            `;
            document.head.appendChild(style);

            console.log('Search setup completed');
        } else {
            console.error('Search elements not found!');
        }
    }

    // Initialize when DOM is loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }

    function initialize() {
        console.log('Initializing...');
        updateNavigation();
        setActiveLink();
        setupLogout();
        setupSearch();
        console.log('Initialization completed');
    }

    // Export functions for other modules to use
    window.updateNavigation = updateNavigation;
</script>


