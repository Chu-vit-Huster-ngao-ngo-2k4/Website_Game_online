<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chơi Game</title>

    <style>
        .comment-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            margin-bottom: 10px;
        }

        .comment-time {
            color: #666;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .comment-text {
            margin-top: 5px;
        }
    </style>

</head>

<body>

    <h1 id="gameTitle">Đang tải game...</h1>
    <iframe id="gameFrame" width="400" height="600" frameborder="0"></iframe>

    <div class="comment">
        <h2>Bình luận</h2>
        <div id="commentSection">
            <input type="text" id="comment-input" placeholder="Nhập bình luận...">
            <button onclick="postComment()">Gửi</button>
        </div>
        <div id="commentsList"></div>
    </div>

    <script type="module">
        import { formatDateTime } from '../src/reuse_model/formatDateTime.js';
        window.formatDateTime = formatDateTime; // Make it available globally
    </script>

    <script>
        
        const params = new URLSearchParams(window.location.search);
        const gameId = params.get("game");

        

        // Tạo lịch sử game 
        async function addToHistory(gameData) {
            try {
                const maxHistoryItems = 5; // Số lượng game tối đa trong lịch sử
                let gameHistory = JSON.parse(localStorage.getItem("gameHistory")) || [];

                // Kiểm tra xem game đã tồn tại trong lịch sử chưa
                const existingIndex = gameHistory.findIndex(item => item.id === gameData.id);
                if (existingIndex !== -1) {
                    // Nếu game đã tồn tại, xóa nó khỏi danh sách
                    gameHistory.splice(existingIndex, 1);
                }

                // Thêm game mới vào đầu danh sách
                gameHistory.unshift({
                    id: gameData.id,
                    title: gameData.title,
                    thumbnail: gameData.thumbnail,
                    played_at: new Date().toISOString()
                });

                // Giới hạn số lượng game trong lịch sử
                if (gameHistory.length > maxHistoryItems) {
                    gameHistory = gameHistory.slice(0, maxHistoryItems);
                }

                // Lưu lại lịch sử vào localStorage
                localStorage.setItem("gameHistory", JSON.stringify(gameHistory));

            } catch (error) {
                console.error("Lỗi khi thêm game vào lịch sử:", error);
            }
        }



        async function loadGame() {
            if (!gameId) {
                document.getElementById("gameTitle").innerText = "Game không hợp lệ!";
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/games/get?id=${gameId}`);
                if (!response.ok) throw new Error("Lỗi khi tải game");

                const game = await response.json();
                if (game) {
                    document.getElementById("gameTitle").innerText = game.title;
                    document.getElementById("gameFrame").src = game.iframe_url;

                    // Thêm game vào lịch sử khi load thành công
                    const gameData = {
                        id: game.id,
                        title: game.title,
                        thumbnail: game.thumbnail,
                        played_at: new Date().toISOString()
                    };
                    console.log('Saving game to history:', gameData); // Thêm log để debug
                    addToHistory(gameData);

                    if (gameId) {
                        loadComments(gameId);
                    }
                } else {
                    document.getElementById("gameTitle").innerText = "Game không tồn tại!";
                }
            } catch (error) {
                console.error(error);
                document.getElementById("gameTitle").innerText = "Lỗi khi tải game!";
            }
        }

        async function loadComments(gameId) {
            try {
                const token = localStorage.getItem("token");
                if (!token) {
                    console.log("Chưa đăng nhập, không thể tải bình luận");
                    return;
                }


                const response = await fetch(`http://localhost:5000/api/comments/game/${gameId}`, {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    console.log("Token hết hạn hoặc không hợp lệ");
                    localStorage.removeItem("token"); // Clear invalid token
                    return;
                }

                if (!response.ok) throw new Error("Lỗi khi tải bình luận");

                const comments = await response.json();
                let html = comments.map(comment =>
                    `<div class="comment-item">
                        <p><strong>${comment.User?.username || "Người dùng ẩn danh"}</strong> 
                        <span class="comment-time">${formatDateTime(comment.created_at)}</span></p>
                        <p class="comment-text">${comment.comment}</p>
                    </div>`
                ).join("");
                document.getElementById("commentsList").innerHTML = html;
            } catch (error) {
                console.error(error);
            }
        }

        async function postComment() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Bạn cần đăng nhập để bình luận!");
                window.location.href = "login.html";
            }

            const commentText = document.getElementById("comment-input").value.trim();
            if (!commentText) return;

            try {
                const userResponse = await fetch("http://localhost:5000/api/auth/profile", {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (!userResponse.ok) {
                    throw new Error("Lỗi khi lấy thông tin người dùng");
                }

                const userData = await userResponse.json();

                const response = await fetch("http://localhost:5000/api/comments/add", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        game_id: parseInt(gameId, 10),
                        user_id: userData.id,
                        comment: commentText
                    })
                });

                if (!response.ok) throw new Error("Lỗi khi gửi bình luận");

                const newComment = await response.json();
                const commentHTML = `
                    <div class="comment-item">
                        <p><strong>${userData.username}</strong> 
                        <span class="comment-time">${formatDateTime(new Date())}</span></p>
                        <p class="comment-text">${commentText}</p>
                    </div>`;

                const commentsList = document.getElementById("commentsList");
                commentsList.insertAdjacentHTML('afterbegin', commentHTML);

                document.getElementById("comment-input").value = "";
                loadComments(gameId);
            } catch (error) {
                console.error(error);
                alert("Có lỗi xảy ra khi gửi bình luận");
            }
        }

        loadGame();
        loadComments(gameId);
    </script>

</body>

</html>