<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Website</title>
    <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
    
    <style>

    </style>

    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/footer.css">
</head>

<body>
    <!-- Loading screen -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div id="header"></div>
    <main>
        <div class="category-filter">
            <ul class="category-list">
                <li>
                    <button class="category-btn active" data-category="all">
                        <span class="emoji">‚≠ê</span>
                        <span>T·∫•t c·∫£</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="action">
                        <span class="emoji">‚ö°</span>
                        <span>Action</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="adventure">
                        <span class="emoji">üß≠</span>
                        <span>Adventure</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="arcade">
                        <span class="emoji">üëª</span>
                        <span>Arcade</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="board">
                        <span class="emoji">üé≤</span>
                        <span>Board Game</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="card">
                        <span class="emoji">‚ù§Ô∏è</span>
                        <span>Card Game</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="casual">
                        <span class="emoji">‚òÄÔ∏è</span>
                        <span>Casual</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="educational">
                        <span class="emoji">üìö</span>
                        <span>Educational</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="fighting">
                        <span class="emoji">‚úä</span>
                        <span>Fighting</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="horror">
                        <span class="emoji">üíÄ</span>
                        <span>Horror</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="music">
                        <span class="emoji">üéµ</span>
                        <span>Music & Rhythm</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="platformer">
                        <span class="emoji">üë£</span>
                        <span>Platformer</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="puzzle">
                        <span class="emoji">üß©</span>
                        <span>Puzzle</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="racing">
                        <span class="emoji">üöó</span>
                        <span>Racing</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="rpg">
                        <span class="emoji">üßô‚Äç‚ôÇÔ∏è</span>
                        <span>RPG</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="shooter">
                        <span class="emoji">üéØ</span>
                        <span>Shooter</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="simulation">
                        <span class="emoji">ü§ñ</span>
                        <span>Simulation</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="sports">
                        <span class="emoji">üèÄ</span>
                        <span>Sports</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="strategy">
                        <span class="emoji">‚ôû</span>
                        <span>Strategy</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="survival">
                        <span class="emoji">‚õ∫</span>
                        <span>Survival</span>
                    </button>
                </li>
                <li>
                    <button class="category-btn" data-category="tower-defense">
                        <span class="emoji">‚ôú</span>
                        <span>Tower Defense</span>
                    </button>
                </li>
            </ul>
        </div>
        <div class="container">
            <div class="search-container">
                <form onsubmit="return false;" role="search" aria-label="T√¨m ki·∫øm game">
                    <input type="text" 
                           class="search-bar" 
                           placeholder="T√¨m ki·∫øm game..." 
                           id="searchInput"
                           aria-label="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm"
                           aria-describedby="searchDescription">
                    <button type="button" 
                            class="search-btn" 
                            id="searchBtn"
                            aria-label="T√¨m ki·∫øm">
                        <i class="fas fa-search"></i>
                    </button>
                    <div id="searchDescription" class="visually-hidden">
                        Nh·∫•n Enter ƒë·ªÉ t√¨m ki·∫øm, ho·∫∑c s·ª≠ d·ª•ng ph√≠m t·∫Øt Ctrl+K
                    </div>
                </form>
                <div class="search-loading" id="searchLoading" aria-hidden="true">
                    <div class="spinner"></div>
                </div>
            </div>
           

        <style>
            .search-container {
                max-width: 500px;
                margin: 0px auto;
                position: fixed;
                top: 20px;
                left: 40%;
                z-index: 150;
            }
        
            .search-bar {
                width: 100%;
                border: none;
                border-radius: 20px;
                background: #2a2a3a;
                color: #fff;
                font-size: 14px;
                transition: all 0.3s ease;
                padding: 10px 40px 10px 15px;
            }
        
            .search-bar:focus {
                outline: none;
                box-shadow: 0 0 0 2px #4CAF50;
                background: #2f2f42;
            }
        
            .search-bar::placeholder {
                color: #888;
            }
        
            .search-btn {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #888;
                cursor: pointer;
                padding: 5px;
                transition: color 0.3s ease;
            }
        
            .search-btn:hover {
                color: #4CAF50;
            }
        
            .search-loading {
                display: none;
                position: absolute;
                right: 40px;
                top: 50%;
                transform: translateY(-50%);
            }
        
            .search-loading.active {
                display: block;
            }
        
            .search-loading .spinner {
                width: 16px;
                height: 16px;
                border: 2px solid #4CAF50;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }
        
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        
            .no-results-message {
                text-align: center;
                padding: 20px;
                color: #888;
                background: #2a2a3a;
                border-radius: 8px;
                margin: 20px 0;
                animation: fadeIn 0.3s ease;
            }
        
            .no-results-message p {
                margin: 5px 0;
            }
        
            .game-item {
                transition: all 0.3s ease;
            }
        
            .game-item.hidden {
                opacity: 0;
                transform: scale(0.95);
            }
        
            .visually-hidden {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                border: 0;
            }
        
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        </style>
        
        <script>
            // Debounce function
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        
            // Setup search functionality
            function setupSearch() {
                const searchInput = document.getElementById('searchInput');
                const searchBtn = document.getElementById('searchBtn');
                const searchLoading = document.getElementById('searchLoading');

                if (searchInput && searchBtn) {
                    const handleSearch = async () => {
                        const searchTerm = searchInput.value.toLowerCase().trim();
                        const gameList = document.querySelector('.game-list');
                        
                        if (!gameList) {
                            console.error('Game list container not found!');
                            return;
                        }
                        
                        const games = gameList.querySelectorAll('.game-item');
                        if (games.length === 0) {
                            console.error('No game items found in the game list!');
                            return;
                        }

                        // N·∫øu searchTerm r·ªóng, hi·ªán t·∫•t c·∫£ game ngay l·∫≠p t·ª©c
                        if (searchTerm === '') {
                            games.forEach(game => {
                                game.style.display = 'block';
                            });
                            const noResultsMessage = document.querySelector('.no-results-message');
                            if (noResultsMessage) {
                                noResultsMessage.remove();
                            }
                            return;
                        }

                        // Show loading state
                        searchLoading.classList.add('active');

                        let visibleGames = 0;

                        // X·ª≠ l√Ω t√¨m ki·∫øm
                        games.forEach(game => {
                            const title = game.querySelector('.game-title')?.textContent.toLowerCase() || '';
                            const category = game.querySelector('.game-category')?.textContent.toLowerCase() || '';
                            
                            if (title.includes(searchTerm) || category.includes(searchTerm)) {
                                game.style.display = 'block';
                                visibleGames++;
                            } else {
                                game.style.display = 'none';
                            }
                        });

                        // Hi·ªÉn th·ªã th√¥ng b√°o khi kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£
                        const noResultsMessage = document.querySelector('.no-results-message');
                        if (visibleGames === 0) {
                            if (!noResultsMessage) {
                                const message = document.createElement('div');
                                message.className = 'no-results-message';
                                message.innerHTML = `
                                    <p>Kh√¥ng t√¨m th·∫•y game n√†o ph√π h·ª£p v·ªõi "${searchTerm}"</p>
                                    <p>Vui l√≤ng th·ª≠ t·ª´ kh√≥a kh√°c</p>
                                `;
                                gameList.appendChild(message);
                            }
                        } else if (noResultsMessage) {
                            noResultsMessage.remove();
                        }

                        // Reset category filter khi t√¨m ki·∫øm
                        const categoryButtons = document.querySelectorAll('.category-btn');
                        if (categoryButtons.length > 0) {
                            categoryButtons.forEach(btn => {
                                btn.classList.remove('active');
                            });
                            const allCategoryBtn = document.querySelector('.category-btn[data-category="all"]');
                            if (allCategoryBtn) {
                                allCategoryBtn.classList.add('active');
                            }
                        }

                        // Hide loading state
                        setTimeout(() => {
                            searchLoading.classList.remove('active');
                        }, 300);
                    };

                    // Debounced search function
                    const debouncedSearch = debounce(handleSearch, 300);

                    // X·ª≠ l√Ω s·ª± ki·ªán click n√∫t t√¨m ki·∫øm
                    searchBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleSearch();
                    });

                    // X·ª≠ l√Ω s·ª± ki·ªán input v·ªõi debounce
                    searchInput.addEventListener('input', debouncedSearch);

                    // X·ª≠ l√Ω s·ª± ki·ªán ph√≠m Enter
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleSearch();
                        }
                    });

                    // Th√™m ph√≠m t·∫Øt
                    document.addEventListener('keydown', (e) => {
                        // Ctrl + K ho·∫∑c Command + K
                        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                            e.preventDefault();
                            searchInput.focus();
                        }
                    });
                }
            }
        
            // Initialize search when DOM is loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupSearch);
            } else {
                setupSearch();
            }
        </script>

        <div id="gameList" class="game-list">
            <!-- Games will be loaded here -->
        </div>
    </main>

    <div id="footer"></div>

    <script type="module">
        import { games } from './js/modules/games.js';
        import { auth } from './js/modules/auth.js';
        import { ui } from './js/modules/ui.js';

        // Load header and footer first
        async function loadComponents() {
            try {
                // Load header
                const headerResponse = await fetch('./reuse_model/head.html');
                const headerHtml = await headerResponse.text();
                document.getElementById('header').innerHTML = headerHtml;
                
                // Load footer
                const footerResponse = await fetch('./reuse_model/footer.html');
                const footerHtml = await footerResponse.text();
                document.getElementById('footer').innerHTML = footerHtml;

           // Load header script
           const script = document.createElement('script');
                script.src = './js/header.js';
                script.onload = () => {
                    if (typeof window.initHeader === 'function') {
                        window.initHeader();
                    } else {
                        console.error('initHeader function not found!');
                    }
                };
                document.head.appendChild(script);

                // Show content when components are loaded
                document.body.classList.add('loaded');
                document.getElementById('header').classList.add('loaded');
                document.querySelector('main').classList.add('loaded');
                document.getElementById('footer').classList.add('loaded');
                
                // Hide loading screen
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.add('fade-out');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Start loading components
        loadComponents();

        // Load games
        async function loadGames() {
            try {
                const gamesList = await games.getAllGames();
                const gameListElement = document.getElementById('gameList');
                
                if (gamesList.length === 0) {
                    gameListElement.innerHTML = `
                        <div class="no-games">
                            <p>Ch∆∞a c√≥ game n√†o trong h·ªá th·ªëng.</p>
                        </div>
                    `;
                    return;
                }

                // Base64 placeholder image for games without thumbnail
                const defaultImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzJhMmEzYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiM4ODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';

                console.log('Games data:', gamesList); // Debug log

                gameListElement.innerHTML = gamesList.map(game => {
                    // Debug log for each game
                    console.log('Processing game:', game);
                    
                    return `
                        <div class="game-item" data-category="${game.category || 'uncategorized'}">
                            <img src="${game.thumbnail || defaultImage}" 
                                 alt="${game.title}" 
                                 class="game-thumbnail" 
                                 onerror="this.onerror=null; this.src='${defaultImage}';">
                            <div class="game-info">
                                <h3 class="game-title">${game.title}</h3>
                                <p class="game-category">${game.category || 'Ch∆∞a ph√¢n lo·∫°i'}</p>
                            </div>
                            <div class="game-overlay">
                                <a href="play.html?id=${game.id}" class="play-button">Ch∆°i ngay</a>
                            </div>
                        </div>
                    `;
                }).join('');

                // Th√™m x·ª≠ l√Ω l·ªói ·∫£nh
                document.querySelectorAll('.game-thumbnail').forEach(img => {
                    img.addEventListener('error', function() {
                        console.log('Image load error for:', this.src); // Debug log
                        this.src = defaultImage;
                    });
                });

                // Kh·ªüi t·∫°o l·∫°i ch·ª©c nƒÉng t√¨m ki·∫øm sau khi games ƒë∆∞·ª£c load
                setupSearch();
            } catch (error) {
                console.error('Error loading games:', error);
                ui.showMessage('Kh√¥ng th·ªÉ t·∫£i danh s√°ch game', 'error');
            }
        }

        // Category filter
        document.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Update active button
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const category = button.dataset.category;
                const games = document.querySelectorAll('.game-item');

                games.forEach(game => {
                    if (category === 'all' || game.dataset.category === category) {
                        game.style.display = 'block';
                    } else {
                        game.style.display = 'none';
                    }
                });
            });
        });

        // Load games on page load
        loadGames();
    </script>
</body>

</html>